<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Classroom Display</title>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #1a1a1a;
      color: white;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 30px;
      text-align: center;
    }
    .classroom-code {
      font-size: 72px;
      font-weight: bold;
      margin: 10px 0;
    }
    .schedule {
      padding: 40px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .class-item {
      background: #2a2a2a;
      padding: 30px;
      margin: 20px 0;
      border-radius: 10px;

      border-left: 5px solid #667eea;
      font-size: 24px;
    }
    .error {
      text-align: center;
      padding: 100px 20px;

      color: #e74c3c;
    }
    .connection-status {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;

      border-radius: 8px;
      font-weight: bold;
      font-size: 18px;
    }
    .connected { background: #27ae60; }
    .disconnected { background: #e74c3c; }
    .connecting { background: #f39c12; }
  </style>
</head>
<body>

  <div id="error" class="error" style="display: none;"></div>
  

  <div id="display" style="display: none;">
    <div class="connection-status connecting" id="status">

      ‚ö†Ô∏è Connecting...
    </div>

    <div class="header">
      <div class="classroom-code" id="classroomCode">---</div>
      <div style="font-size: 24px;" id="buildingRoom">Building: -- | Room: ---</div>
    </div>

    <div class="schedule" id="schedule">
      <h2>üìÖ Today's Schedule</h2>
      <div id="scheduleContent">Waiting for schedule...</div>
    </div>
  </div>

  <script>
    let socket = null;


    // Get classroom from URL parameter
    function getClassroomFromURL() {

      const params = new URLSearchParams(window.location.search);
      return params.get('classroom');
    }

    // Initialize
    const classroom = getClassroomFromURL();

    if (!classroom) {
      // No classroom parameter in URL

      document.getElementById('error').style.display = 'block';
      document.getElementById('error').innerHTML = `
        <h1>‚ö†Ô∏è Configuration Error</h1>
        <p>No classroom specified in URL.</p>
        <p>Please use: <code>display.html?classroom=AH302</code></p>
      `;
    } else if (!/^[A-Z]{1,3}[0-9]{1,4}$/i.test(classroom)) {
      // Invalid classroom format
      document.getElementById('error').style.display = 'block';

      document.getElementById('error').innerHTML = `
        <h1>‚ö†Ô∏è Invalid Classroom Code</h1>
        <p>Classroom code "${classroom}" is invalid.</p>
        <p>Format should be: Letters + Numbers (e.g., AH302, EL304)</p>
      `;
    } else {
      // Valid classroom - show display and connect
      document.getElementById('display').style.display = 'block';
      document.getElementById('classroomCode').textContent = classroom.toUpperCase();
      
      // Parse and display building/room
      const match = classroom.match(/^([A-Z]+)(\d+)$/i);
      if (match) {
        const building = match[1].toUpperCase();
        const room = match[2];
        document.getElementById('buildingRoom').textContent = 
          `Building: ${building} | Room: ${room}`;
      }

      
      // Connect to WebSocket
      connectToWebSocket(classroom.toUpperCase());
    }

    function connectToWebSocket(classroom) {
      console.log('Connecting to /screens namespace with classroom:', classroom);
      
      socket = io('http://localhost:3000/screens', {
        query: { classroom: classroom },
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionAttempts: Infinity,  // Keep trying forever
      });

      socket.on('connect', () => {
        console.log('‚úÖ Connected!', socket.id);
        updateStatus('‚úÖ Connected', 'connected');
      });


      socket.on('disconnect', () => {
        console.log('‚ùå Disconnected');
        updateStatus('‚ö†Ô∏è Disconnected', 'disconnected');
      });

      socket.on('connect_error', (error) => {
        console.error('Connection error:', error);
        updateStatus('‚ö†Ô∏è Connecting...', 'connecting');
      });

      socket.on('updateSchedule', (data) => {

        console.log('üìÖ Schedule received:', data);
        displaySchedule(data);
      });

      socket.on('announcement', (data) => {
        console.log('üì¢ Announcement:', data);
        displayAnnouncement(data);
      });
    }

    function updateStatus(text, className) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = text;
      statusEl.className = `connection-status ${className}`;
    }

    function displaySchedule(data) {
      const container = document.getElementById('scheduleContent');
      
      if (!data.classes || data.classes.length === 0) {
        container.innerHTML = '<p style="font-size: 28px;">No classes scheduled for today.</p>';
        return;

      }

      container.innerHTML = data.classes.map(cls => `
        <div class="class-item">
          <h3 style="margin: 0 0 15px 0; font-size: 32px;">${cls.courseCode}: ${cls.courseTitle}</h3>
          <p style="margin: 10px 0;"><strong>Instructor:</strong> ${cls.instructor}</p>
          <p style="margin: 10px 0;"><strong>Time:</strong> ${cls.startTime} - ${cls.endTime}</p>
          <p style="margin: 10px 0;"><strong>Section:</strong> ${cls.section}</p>
        </div>
      `).join('');
    }

    function displayAnnouncement(data) {
      // You can implement announcement display logic here
      // For now, just log it

      console.log('Announcement:', data);

    }
  </script>
</body>
</html>
